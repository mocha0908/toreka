<!DOCTYPE html>
<html lang="ja">
<head>
  <style>
    /* ... (æ—¢å­˜ã®CSS) ... */

    /* â–¼â–¼â–¼ è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
    
    /* ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæœ€æ–°å¼¾ãƒœã‚¿ãƒ³ãªã©ï¼‰ */
    .quick-actions {
      display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;
    }
    .btn-latest {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; padding: 10px 24px;
      border-radius: 50px; font-weight: 700; font-size: 14px;
      cursor: pointer; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
      transition: transform 0.1s;
      display: flex; align-items: center; gap: 6px;
    }
    .btn-latest:active { transform: scale(0.96); }

    /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    .rarity-scroll-area {
      display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
      margin-bottom: 20px;
      padding: 0 10px;
    }
    .btn-rarity-tag {
      background: #fff; border: 1px solid #ddd;
      color: #555; padding: 6px 14px; border-radius: 20px;
      font-size: 12px; font-weight: 700; cursor: pointer;
      transition: all 0.2s;
    }
    .btn-rarity-tag.active {
      background: #333; color: #fff; border-color: #333;
    }
    /* â–²â–²â–² è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ«ã“ã“ã¾ã§ â–²â–²â–² */
  </style>
</head>
<body onload="init()">

  <div class="search-wrapper">
    </div>

  <div class="quick-actions">
    <button class="btn-latest" onclick="fetchLatest()">
      <span>ğŸ”¥</span> æœ€æ–°å¼¾ (M2a)
    </button>
  </div>
  
  <div id="rarityButtonArea" class="rarity-scroll-area" style="display:none;"></div>
  <div class="info-text">
    </div>

  <script>
    // ... (API_URLãªã©ã®æ—¢å­˜å¤‰æ•°) ...
    
    // â–¼â–¼â–¼ è¿½åŠ å¤‰æ•° â–¼â–¼â–¼
    let currentRarityFilter = null; // ãƒ­ãƒ¼ã‚«ãƒ«çµã‚Šè¾¼ã¿ç”¨
    // â–²â–²â–²

    function init() {
      // ... (æ—¢å­˜ã®initå‡¦ç†) ...
    }

    // ... (fetchData, loadData, search ãªã©æ—¢å­˜é–¢æ•°) ...

    // â–¼â–¼â–¼ è¿½åŠ : æœ€æ–°å¼¾å–å¾—é–¢æ•° â–¼â–¼â–¼
    function fetchLatest() {
      showSpinner(true);
      document.getElementById('resultList').innerHTML = "";
      document.getElementById('keyword').value = ""; // æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒªã‚¢
      document.getElementById('raritySelect').value = ""; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒªã‚»ãƒƒãƒˆ
      onRarityChange(); // ãƒ©ãƒ™ãƒ«ãƒªã‚»ãƒƒãƒˆ

      fetchData({ action: 'latest' }).then(data => {
        showSpinner(false);
        if (!data) return;
        
        allData = data.rows || [];
        document.getElementById('listTitle').innerText = "æœ€æ–°å¼¾ (M2a) è²·å–è¡¨";
        
        // â˜…ã“ã“ã§ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
        generateRarityButtons(allData);
        
        // ãƒ•ã‚£ãƒ«ã‚¿åˆæœŸåŒ–ã—ã¦æç”»
        currentRarityFilter = null;
        renderList();
      });
    }

    // â–¼â–¼â–¼ è¿½åŠ : ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒœã‚¿ãƒ³ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
    function generateRarityButtons(rows) {
      const area = document.getElementById('rarityButtonArea');
      const rarities = new Set();
      
      // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¬ã‚¢ãƒªãƒ†ã‚£(Dåˆ—=index 3 ã¨æƒ³å®š)ã‚’åé›†
      rows.forEach(r => {
        if(r[3]) rarities.add(String(r[3]).trim());
      });

      // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãŒãªã„å ´åˆã¯éè¡¨ç¤º
      if (rarities.size === 0) {
        area.style.display = 'none';
        return;
      }

      // ã‚½ãƒ¼ãƒˆã—ã¦ãƒœã‚¿ãƒ³HTMLä½œæˆ
      const sorted = Array.from(rarities).sort();
      let html = `<button class="btn-rarity-tag active" onclick="filterByLocalRarity(null, this)">å…¨ã¦</button>`;
      
      sorted.forEach(rar => {
        html += `<button class="btn-rarity-tag" onclick="filterByLocalRarity('${rar}', this)">${rar}</button>`;
      });

      area.innerHTML = html;
      area.style.display = 'flex';
    }

    // â–¼â–¼â–¼ è¿½åŠ : ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ¬ã‚¢ãƒªãƒ†ã‚£çµã‚Šè¾¼ã¿ â–¼â–¼â–¼
    function filterByLocalRarity(rarity, btn) {
      currentRarityFilter = rarity;
      
      // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®æ›´æ–°
      const btns = document.querySelectorAll('.btn-rarity-tag');
      btns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      renderList(); // å†æç”»
    }
    
    // â–¼â–¼â–¼ æ—¢å­˜ã® renderList ã‚’å°‘ã—ä¿®æ­£ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚£ãƒ«ã‚¿å¯¾å¿œï¼‰ â–¼â–¼â–¼
    function renderList() {
      const container = document.getElementById('resultList');
      // ... (æ—¢å­˜ã®å¤‰æ•°å®šç¾©)

      let rows = allData.filter(row => {
        if (isFavMode && !favorites.has(row[0])) return false;
        
        // â˜…è¿½åŠ : ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒœã‚¿ãƒ³ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
        if (currentRarityFilter) {
          // Dåˆ—(index 3)ã§åˆ¤å®š
          const r = String(row[3] || "").trim();
          if (r !== currentRarityFilter) return false;
        }

        const p = parseFloat(String(row[2]).replace(/,/g, ''));
        if (isNaN(p) || p <= 0) return false;
        return true;
      });

      // ... (ä»¥ä¸‹ã®ã‚½ãƒ¼ãƒˆã‚„HTMLç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯æ—¢å­˜ã®ã¾ã¾) ...
      
      rows.sort((a, b) => {
         // ... (æ—¢å­˜ã®ã‚½ãƒ¼ãƒˆå‡¦ç†)
         const pA = parseFloat(String(a[2]).replace(/,/g, '')) || 0;
         const pB = parseFloat(String(b[2]).replace(/,/g, '')) || 0;
         if (currentSort === "priceDesc") return pB - pA;
         if (currentSort === "priceAsc") return pA - pB;
         // ...
         return 0;
      });
      
      // ... (HTMLç”Ÿæˆã—ã¦ container.innerHTML = html ã™ã‚‹ã¨ã“ã‚ã¾ã§åŒã˜) ...
      
      // å¿µã®ãŸã‚ã‚³ãƒ”ãƒ¼
      if (rows.length === 0) {
        container.innerHTML = `<p style="text-align:center;color:#999;padding:40px;">è©²å½“ã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
        return;
      }

      let html = "";
      rows.forEach(row => {
         // ... (æ—¢å­˜ã®è¡Œç”Ÿæˆå‡¦ç†) ...
         const name = row[0];
         const img = row[1];
         const price = row[2];
         const isFav = favorites.has(name);
         // ... (ç”»åƒã‚¿ã‚°ç”Ÿæˆãªã©) ...
         
         html += `
           <div class="item-row ${isFav ? 'is-favorite' : ''}">
             <div class="item-img">${ (img && /^http/.test(img)) ? `<img src="${img}" loading="lazy" onclick="showModal('${img}')">` : `<span style="font-size:10px;color:#ccc;">No Img</span>` }</div>
             <div class="item-info">
               <div class="item-title-row">
                 <span class="star-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${name.replace(/'/g,"\\'")} ', this)">â˜…</span>
                 <div class="item-title">${name}</div>
               </div>
               <div class="item-price-row">
                 <span class="price-label">è²·å–</span>
                 <span class="price-val">Â¥${Number(price).toLocaleString()}</span>
               </div>
             </div>
           </div>
         `;
      });
      container.innerHTML = html;
    }
    
    // é€šå¸¸æ¤œç´¢æ™‚ã¯ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’éš ã™å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
    const originalSearch = search;
    search = function() {
      document.getElementById('rarityButtonArea').style.display = 'none'; // éš ã™
      currentRarityFilter = null; // ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤
      originalSearch();
    }

  </script>
</body>
</html>