<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Éà„É¨„Ç´„Ç≠„É≥„Ç∞„ÉÄ„É† Ë≤∑ÂèñÊ§úÁ¥¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0056b3;
      --primary-light: #eef4ff;
      --accent: #e60012;
      --bg: #f4f7f6;
      --card-bg: #ffffff;
      --text: #222;
      --text-sub: #666;
      --border: #dfe3e8;
      --radius: 12px;
      --gold: #f1c40f;
      --shadow: 0 2px 8px rgba(0,0,0,0.06);
      --f-size: 15px;
      --search-height: 76px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Noto Sans JP', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; }

    /* „Éò„ÉÉ„ÉÄ„Éº */
    header { background: #fff; padding: 16px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 20; position: relative; }
    .site-logo img { max-width: 160px; height: auto; }

    /* Ê§úÁ¥¢„Éê„Éº (Sticky) */
    .search-sticky {
      position: sticky; top: 0; z-index: 100;
      background: rgba(244, 247, 246, 0.95); backdrop-filter: blur(10px);
      padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.05);
      height: var(--search-height); display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .search-box {
      flex: 1; max-width: 800px; display: flex; align-items: center;
      background: #fff; border-radius: 50px; border: 1px solid var(--border);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05); padding-right: 6px;
    }
    .search-box input {
      border: none; background: transparent; padding: 12px 20px;
      font-size: 16px; flex: 1; outline: none; border-radius: 50px;
    }
    .btn-circle {
      width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
      transition: transform 0.1s;
    }
    .btn-circle:active { transform: scale(0.95); }
    .btn-search { background: var(--primary); color: white; box-shadow: 0 2px 6px rgba(0,86,179,0.3); }
    .btn-search svg { width: 22px; height: 22px; fill: white; }
    
    .btn-fav-filter { background: #fff; border: 1px solid #ddd; color: #ccc; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .btn-fav-filter.active { background: var(--gold); border-color: var(--gold); color: #fff; }
    .btn-fav-filter svg { width: 24px; height: 24px; fill: currentColor; }

    /* „Ç≥„É≥„Éà„É≠„Éº„É´ */
    .controls-area { max-width: 1000px; margin: 0 auto; padding: 16px; }
    .filter-scroll {
      display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px;
      -webkit-overflow-scrolling: touch; scrollbar-width: none; align-items: center;
    }
    .filter-scroll::-webkit-scrollbar { display: none; }
    
    .chip {
      white-space: nowrap; padding: 0 16px; border-radius: 24px;
      background: #fff; border: 1px solid var(--border); color: var(--text-sub);
      font-size: 14px; font-weight: 500; cursor: pointer;
      display: flex; align-items: center; gap: 6px; height: 44px; flex-shrink: 0;
    }
    .chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .chip select, .chip input { border: none; background: transparent; color: inherit; font: inherit; outline: none; height: 100%; }
    .chip select { cursor: pointer; padding-right: 4px; }
    .chip input.direct-input { width: 90px; }
    .chip input::placeholder { color: #aaa; }
    .chip.active input::placeholder { color: rgba(255,255,255,0.7); }

    /* ‰øùË®ºË°® */
    details.guarantee-box { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
    details.guarantee-box summary {
      padding: 14px 20px; font-weight: 700; color: var(--primary); cursor: pointer; outline: none;
      display: flex; align-items: center; justify-content: space-between;
    }
    .guarantee-scroller { overflow-x: auto; white-space: nowrap; padding: 0 16px 20px; -webkit-overflow-scrolling: touch; }
    .guarantee-card { display: inline-block; background: #fff; padding: 10px 16px; border-radius: 12px; margin-right: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; min-width: 80px; }
    .guarantee-card .g-label { font-size: 11px; color: #888; display: block; margin-bottom: 4px; }
    .guarantee-card .g-price { font-family: 'Roboto', sans-serif; font-weight: 700; color: #333; font-size: 16px; }

    /* „É™„Çπ„Éà */
    #result-container { max-width: 1000px; margin: 0 auto; padding: 0 16px; }
    
    /* „Ç´„Éº„Éâ„Çπ„Çø„Ç§„É´ (Mobile) */
    .card-grid { display: grid; gap: 12px; }
    .card {
      background: #fff; border-radius: var(--radius); box-shadow: var(--shadow);
      display: grid; grid-template-columns: 80px 1fr; position: relative; overflow: hidden;
      transition: border 0.2s;
    }
    .card.is-favorite { border: 2px solid var(--gold); }
    
    .card-img {
      background: #fafafa; display: flex; align-items: center; justify-content: center; cursor: zoom-in;
    }
    .card-img img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }
    
    .card-body { padding: 12px; display: flex; flex-direction: column; justify-content: center; gap: 6px; }
    .card-title {
      font-size: var(--f-size); font-weight: 700; line-height: 1.4;
      display: flex; align-items: center; gap: 6px;
    }
    .card-price-area { margin-top: 4px; }
    .main-price {
      font-family: 'Roboto', sans-serif; font-weight: 900; color: var(--accent);
      font-size: calc(var(--f-size) + 6px);
    }
    .main-price::before { content: 'Ë≤∑Âèñ'; font-size: 11px; color: #888; font-weight: normal; margin-right: 4px; }

    /* „Çπ„Çø„Éº„Ç¢„Ç§„Ç≥„É≥ */
    .star-icon { font-size: 22px; color: #ddd; cursor: pointer; line-height: 1; }
    .star-icon.active { color: var(--gold); }
    
    /* „ÉÜ„Éº„Éñ„É´„Çπ„Çø„Ç§„É´ (Desktop) */
    @media (min-width: 768px) {
      .card-grid { display: none; }
      .desktop-table-wrap {
        display: block !important; background: #fff; border-radius: var(--radius);
        box-shadow: var(--shadow); overflow: visible; border: 1px solid #eee;
      }
      table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: var(--f-size); }
      th {
        background: #f8f9fa; padding: 14px; text-align: center; font-weight: 700; color: #555;
        border-bottom: 2px solid #ddd; position: sticky; top: var(--search-height); z-index: 10; white-space: nowrap;
      }
      td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; vertical-align: middle; }
      tr:hover { background: #f0f7ff; }
      tr.is-favorite { background: #fffdf0; }
      th:first-child { text-align: left; min-width: 300px; }
      td:first-child { text-align: left; font-weight: bold; }
      img.tbl-thumb { width: 50px; height: 50px; object-fit: contain; }
    }
    .desktop-table-wrap { display: none; }

    /* „Åù„ÅÆ‰ªñ */
    .spinner { display: none; flex-direction: column; align-items: center; padding: 40px; color: #888; gap:10px;}
    .spinner-circle { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin .8s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .pager { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
    .pager btn {
      width: 36px; height: 36px; border-radius: 8px; border: 1px solid #ddd; background: #fff;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .pager btn:hover { background: #eee; }
    .pager btn.disabled { opacity: 0.4; pointer-events: none; }

    mark { background: rgba(255, 213, 0, 0.4); padding: 0; }
    #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.85); z-index: 9999; align-items: center; justify-content: center; }
    #modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
    #toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: #222; color: #fff; padding: 10px 20px; border-radius: 30px;
      font-size: 13px; opacity: 0; visibility: hidden; transition: all .3s; z-index: 10000;
    }
    #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body onload="init()">

  <header>
    <div class="site-logo"><img src="https://i.imgur.com/ZXFdMYn.png" alt="LOGO"></div>
  </header>

  <div class="search-sticky">
    <div class="search-box">
      <input type="text" id="keyword" placeholder="„Ç´„Éº„ÉâÂêç„ÉªÂûãÁï™" enterkeyhint="search">
    </div>
    <div class="btn-circle btn-search" onclick="search()"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 3 13.09 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div>
    <div class="btn-circle btn-fav-filter" id="favFilterBtn" onclick="toggleFavFilter()" title="„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„ÅøË°®Á§∫"><svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div>
  </div>

  <div class="controls-area">
    <p style="text-align:center;font-size:12px;color:#666;margin-top:-5px;">‚Äª‰æ°Ê†º„ÅØÂú®Â∫´Áä∂Ê≥ÅÁ≠â„Å´„Çà„ÇäÂ§âÂãï„Åó„Åæ„Åô <span id="lastUpdatedDisplay" style="color:#0056b3;font-weight:bold;"></span></p>
    
    <div class="filter-scroll" style="margin-bottom: 12px;">
      <div class="chip" id="rarChip"><span>üíé</span><select id="raritySelect"><option value="">ÂÖ®„É¨„Ç¢„É™„ÉÜ„Ç£</option></select></div>
      <div class="chip" onclick="toggleSort()"><span id="sortIcon">‚áÖ</span><span id="sortLabel">‰æ°Ê†ºÈ†Ü(È´ò)</span></div>
    </div>

    <h3>ÊúÄ‰Ωé‰øùË®ºË≤∑Âèñ</h3>
    <div class="guarantee-scroller">
      <div class="guarantee-card"><span class="g-label">PSA10</span><div class="g-price">¬•5,000</div></div>
      <div class="guarantee-card"><span class="g-label">SAR</span><div class="g-price">¬•400</div></div>
      <div class="guarantee-card"><span class="g-label">SR</span><div class="g-price">¬•250</div></div>
      <div class="guarantee-card"><span class="g-label">AR</span><div class="g-price">¬•220</div></div>
      <div class="guarantee-card"><span class="g-label">RR</span><div class="g-price">¬•10</div></div>
    </div>

    <div id="spinner" class="spinner"><div class="spinner-circle"></div><span>Ë™≠„ÅøËæº„Åø‰∏≠...</span></div>
    
    <div id="result-container">
      <div id="cardView" class="card-grid"></div>
      <div id="tableView" class="desktop-table-wrap"></div>
      <div id="pager" class="pager"></div>
    </div>
  </div>

  <div id="modal" onclick="this.style.display='none'"><img id="modalImage" src=""></div>
  <div id="toast">‚úÖ <span id="toastMsg"></span></div>

  <script>
    // ‚òÖ‚òÖ‚òÖ „ÅîÊåáÂÆö„ÅÆURL„ÇíË®≠ÂÆöÊ∏à„Åø ‚òÖ‚òÖ‚òÖ
    const API_URL = "https://script.google.com/macros/s/AKfycbw-P6xNeIAaiD32vlVFDHR4p6T8_snDuJwRaGfGoE6k6uJSDsyk_1z2Pl220oA8pxV5mA/exec";

    const state = { rows:[], page:1, pageSize:100, sort:{idx:2,dir:'desc'}, terms:{andTerms:[],orTerms:[]}, initialKey:'ALL' };
    let favorites = new Set();
    let isFavFilterMode = false;

    function init() {
      loadFavorites(); loadRarityList(); loadPickupTable();
      setupEvents();
    }

    function setupEvents(){
      document.getElementById('keyword').addEventListener('keydown', e=>{if(e.key==='Enter')search()});
      document.getElementById('raritySelect').addEventListener('change', ()=>search());
    }

    async function fetchData(p) {
      const u = new URL(API_URL); Object.keys(p).forEach(k=>u.searchParams.append(k,p[k]));
      try { const r=await fetch(u); return await r.json(); } catch(e){ return null; }
    }

    function loadRarityList(){
      fetchData({action:'rarityList'}).then(list=>{
        if(!list)return;
        const rSel=document.getElementById('raritySelect');
        list.forEach(r=>{const o=document.createElement('option');o.value=r;o.innerText=r;rSel.appendChild(o)});
      });
    }

    function loadPickupTable(){
      document.getElementById('spinner').style.display="flex";
      fetchData({action:'pickup'}).then(d=>{
        document.getElementById('spinner').style.display="none";
        if(d){ state.rows=d.rows||[]; if(d.lastUpdated) document.getElementById('lastUpdatedDisplay').innerText=`(${formatDate(d.lastUpdated)})`; render(); }
      });
    }

    function search(){
      const k=document.getElementById('keyword').value.trim();
      const r=document.getElementById('raritySelect').value;
      document.getElementById('spinner').style.display="flex";
      document.getElementById('cardView').innerHTML=""; document.getElementById('tableView').innerHTML="";
      
      state.terms = parseQuery(k);
      // Ë≤∑ÂèñÊ§úÁ¥¢„Å™„ÅÆ„Åß„ÄÅ„Ç´„ÉÜ„Ç¥„É™„ÇÑ‰æ°Ê†º‰∏ãÈôê„Å™„Å©„ÅØ‰∏çË¶Å„ÄÇ„Ç∑„É≥„Éó„É´„Å´„É¨„Ç¢„É™„ÉÜ„Ç£„Å®„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢
      fetchData({action:'search', keyword:k, rarity:r}).then(d=>{
        document.getElementById('spinner').style.display="none";
        if(d){ state.rows=d.rows||[]; state.page=1; state.sort={idx:2,dir:'desc'}; render(); }
      });
    }

    function filterRows(){
      let res = state.rows;
      if(isFavFilterMode) res = res.filter(r => favorites.has(r[0]));
      
      // 0ÂÜÜÈô§Â§ñ
      res = res.filter(r => { const p = Number(r[2]); return !isNaN(p) && p > 0; });
      
      const { idx, dir } = state.sort;
      res.sort((a,b) => {
        const va = a[idx], vb = b[idx];
        const isNum = idx >= 2; 
        if(isNum) return ( (Number(va)||0) - (Number(vb)||0) ) * (dir==='asc'?1:-1);
        return String(va||"").localeCompare(String(vb||""), 'ja') * (dir==='asc'?1:-1);
      });
      return res;
    }

    function render(){
      const all = filterRows();
      if(all.length===0) {
        const msg = `<div style="text-align:center;padding:40px;color:#999;">Êù°‰ª∂„Å´‰∏ÄËá¥„Åô„Çã„Ç´„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>`;
        document.getElementById('cardView').innerHTML=msg; document.getElementById('tableView').innerHTML=msg; document.getElementById('pager').innerHTML=""; return;
      }
      const start = (state.page-1)*state.pageSize;
      const view = all.slice(start, Math.min(start+state.pageSize, all.length));
      renderMobile(view); renderDesktop(view);
      renderPager(state.page, Math.ceil(all.length/state.pageSize));
    }

    function renderMobile(rows){
      let h="";
      rows.forEach(r=>{
        const [n,img,pA]=r;
        const isFav = favorites.has(n);
        const imTag = (img&&/^http/.test(img))?`<img src="${img}" loading="lazy" onclick="showModal('${img}')">`:`<span style="color:#ccc;font-size:10px">NO IMG</span>`;
        const nameH = highlight(n);
        h+=`<div class="card ${isFav?'is-favorite':''}"><div class="card-img">${imTag}</div><div class="card-body">
            <div class="card-title"><span class="star-icon ${isFav?'active':''}" onclick="toggleFav('${n.replace(/'/g,"\\'")} ',this)">‚òÖ</span> ${nameH}</div>
            <div class="card-price-area"><div class="main-price">¬•${Number(pA).toLocaleString()}</div></div>
            </div></div>`;
      });
      document.getElementById('cardView').innerHTML=h;
    }

    function renderDesktop(rows){
      let h=`<table><thead><tr>`;
      [{n:"„Ç´„Éº„ÉâÂêç",w:"auto"},{n:"ÁîªÂÉè",w:"70px"},{n:"Áä∂ÊÖãA",w:""}].forEach(x=>h+=`<th width="${x.w}">${x.n}</th>`);
      h+=`</tr></thead><tbody>`;
      rows.forEach(r=>{
        const [n,img,pA]=r;
        const isFav = favorites.has(n);
        const imTag = (img&&/^http/.test(img))?`<img class="tbl-thumb" src="${img}" onclick="showModal('${img}')">`:"";
        h+=`<tr class="${isFav?'is-favorite':''}"><td><span class="star-icon ${isFav?'active':''}" onclick="toggleFav('${n.replace(/'/g,"\\'")} ',this)">‚òÖ</span> ${highlight(n)}</td>
            <td>${imTag}</td><td class="price">¬•${Number(pA).toLocaleString()}</td></tr>`;
      });
      document.getElementById('tableView').innerHTML=h+'</tbody></table>';
    }

    function renderPager(cur,max){
      const p=document.getElementById('pager'); if(max<=1){p.innerHTML="";return;}
      const b=(l,t,d)=>`<btn onclick="state.page=${t};render();window.scrollTo({top:0,behavior:'smooth'})" class="${d?'disabled':''}">${l}</btn>`;
      p.innerHTML=`${b('¬´',1,cur===1)}${b('‚Äπ',cur-1,cur===1)}<span style="display:flex;align-items:center;font-size:14px;color:#666;">${cur}/${max}</span>${b('‚Ä∫',cur+1,cur===max)}${b('¬ª',max,cur===max)}`;
    }

    // Helper functions
    function toggleFav(n,el){
      if(event)event.stopPropagation(); n=n.trim();
      if(favorites.has(n)) { favorites.delete(n); if(el)el.classList.remove('active'); }
      else { favorites.add(n); if(el)el.classList.add('active'); }
      localStorage.setItem('tk_favorites',JSON.stringify([...favorites]));
      if(isFavFilterMode) render(); else { const tr=el.closest('tr'); if(tr) favorites.has(n)?tr.classList.add('is-favorite'):tr.classList.remove('is-favorite'); const cd=el.closest('.card'); if(cd) favorites.has(n)?cd.classList.add('is-favorite'):cd.classList.remove('is-favorite');}
    }
    function toggleFavFilter(){
      isFavFilterMode=!isFavFilterMode;
      const b=document.getElementById('favFilterBtn');
      if(isFavFilterMode) b.classList.add('active'); else b.classList.remove('active');
      render();
    }
    function loadFavorites(){ const s=localStorage.getItem('tk_favorites'); if(s) favorites=new Set(JSON.parse(s)); }
    function highlight(s){ let h=String(s); [...state.terms.andTerms,...state.terms.orTerms].forEach(k=>{if(k)h=h.replace(new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),m=>`<mark>${m}</mark>`);}); return h; }
    function parseQuery(r){ const n=(r||"").replace(/[\u3041-\u3096]/g,c=>String.fromCharCode(c.charCodeAt(0)+0x60)).toLowerCase().trim(); if(!n)return{andTerms:[],orTerms:[]}; const o=n.split('|').map(s=>s.trim()).filter(Boolean); return o.length>1?{andTerms:[],orTerms:o}:{andTerms:n.split(/\s+/).map(s=>s.trim()).filter(Boolean),orTerms:[]}; }
    function toggleSort(){ const l=document.getElementById('sortLabel'), c=document.getElementById('sortIcon').parentElement; if(state.sort.idx===2 && state.sort.dir==='desc'){state.sort={idx:0,dir:'asc'};l.innerText="Ê®ôÊ∫ñ(ÂêçÂâçÈ†Ü)";c.classList.remove('active');}else{state.sort={idx:2,dir:'desc'};l.innerText="‰æ°Ê†ºÈ†Ü(È´ò)";c.classList.add('active');} render(); }
    function formatDate(iso){ const d=new Date(iso); return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    function showModal(s){ document.getElementById('modalImage').src=s; document.getElementById('modal').style.display='flex'; }
  </script>
</body>
</html>